variables:
  CONTAINER_IMAGE_REGISTRY: ${ARTIFACTORY_URL}/dkr
  HELM_CHART_PATH: .
  HELM_REPO_PASSWORD: $ARTIFACTORY_PASSWORD
  HELM_REPO_URL: https://artifactory.gtl.net/artifactory/helm-local
  HELM_REPO_USERNAME: $ARTIFACTORY_USERNAME

.helm job:
  image: ${CONTAINER_IMAGE_REGISTRY}/devops-tools-helm-job-runner

.lint chart job:
  extends: .helm job
  stage: .pre
  script:
  - > # Run a series of tests to verify that the chart is well-formed
    helm lint $HELM_CHART_PATH
    --debug

.package chart job:
  extends: .helm job
  stage: build
  artifacts:
    name: ${CI_PROJECT_PATH_SLUG}-${CI_COMMIT_REF_SLUG}
    paths:
    - "*.tgz"
    reports:
      dotenv: ${CI_JOB_NAME_SLUG}.env
  script:
  - | # Define chart definition related variables
    HELM_CHART_NAME=$(helm show chart $HELM_CHART_PATH | grep '^name:' | cut -d':' -f2 | tr -d '[:space:]')
    HELM_CHART_VERSION=${HELM_CHART_VERSION:-$(helm show chart $HELM_CHART_PATH | grep '^version:' | cut -d':' -f2 | tr -d '[:space:]')}
    HELM_CHART_PACKAGE=${HELM_CHART_NAME}-${HELM_CHART_VERSION}.tgz
  - > # Package a chart into a versioned chart archive file
    helm package $HELM_CHART_PATH
    --debug
    --dependency-update
    ${HELM_CHART_APP_VERSION:+--app-version=$HELM_CHART_APP_VERSION}
    ${HELM_CHART_VERSION:+--version=$HELM_CHART_VERSION}
  - | # Store variables into artifact to pass them to further jobs
    (
      echo HELM_CHART_NAME=$HELM_CHART_NAME
      echo HELM_CHART_PACKAGE=$HELM_CHART_PACKAGE
      echo HELM_CHART_VERSION=$HELM_CHART_VERSION
    ) >> ${CI_JOB_NAME_SLUG}.env

.push chart to artifactory job:
  extends: .helm job
  stage: deploy
  resource_group: $CI_JOB_NAME $CI_COMMIT_REF_NAME
  script:
  - > # Push chart package to Artifactory
    helm push-artifactory $HELM_CHART_PACKAGE $HELM_REPO_URL
