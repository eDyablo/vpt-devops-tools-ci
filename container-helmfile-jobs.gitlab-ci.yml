include: container-image-jobs.yaml

variables:
  DEPLOY_RELEASE:
    description: Deploy selected release branch.
    options:
    - 'yes'
    - 'no'
    value: 'no'
  JIRA_TICKET:
    description: Reference ticket. Required for production deployment.
    value: ''
  PRODUCTION_JIRA_TICKET_PATTERN: /^DEPX-[0-9]{3,5}$/

.container helmfile jobs:
  workflow rules:
  - if: >-
      $DEPLOY_RELEASE && $DEPLOY_RELEASE == 'yes'
      && $CI_COMMIT_BRANCH !~ $RELEASE_BRANCH_NAME_PATTERN
    when: never
  - if: >-
      $DEPLOY_RELEASE && $DEPLOY_RELEASE == 'yes'
      && $JIRA_TICKET == ''
    when: never
  - if: >-
      $DEPLOY_RELEASE && $DEPLOY_RELEASE == 'yes'
      && $JIRA_TICKET !~ $PRODUCTION_JIRA_TICKET_PATTERN
    when: never
  - !reference [.container image jobs, workflow rules]

.build container image job:
  extends: .kaniko build container image job
  rules:
  - if: >-
      $DEPLOY_RELEASE && $DEPLOY_RELEASE == 'yes'
      && $CI_COMMIT_BRANCH =~ $RELEASE_BRANCH_NAME_PATTERN
    when: never
  - when: always

.promote release container image job:
  extends: .kaniko clone container image job
  rules:
  - if: >-
      $DEPLOY_RELEASE && $DEPLOY_RELEASE == 'yes'
      && $CI_COMMIT_BRANCH =~ $RELEASE_BRANCH_NAME_PATTERN
  script:
  - SOURCE_CONTAINER_IMAGE_NAME=${ARTIFACTORY_URL}/dkr-release/${CONTAINER_IMAGE_BASE_NAME:-$CI_PROJECT_PATH_SLUG}:${CI_COMMIT_REF_SLUG}
  - CONTAINER_IMAGE_TAG=${CI_COMMIT_BRANCH##*/}-g${CI_COMMIT_SHORT_SHA}
  - !reference [.kaniko clone container image job, script]
  variables:
    CONTAINER_IMAGE_REGISTRY: ${ARTIFACTORY_URL}/dkr-production

.trigger helm chart project job:
  rules:
  - if: $DEPLOY_RELEASE && $DEPLOY_RELEASE == 'yes'
    when: never
  - if: $CI_COMMIT_BRANCH =~ $QA_BRANCH_NAME_PATTERN
    variables:
      DEPLOYMENT_NAME_SUFFIX: ''
      HELMFILE_ENVIRONMENT: qa
  - if: >-
      $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      && $CI_COMMIT_TAG == null
    variables:
      DEPLOYMENT_NAME_SUFFIX: -p${CI_PROJECT_ID}-${CI_COMMIT_REF_SLUG}
      HELMFILE_ENVIRONMENT: dev
      UPSTREAM_ENVIRONMENT_AUTOSTOP: 2 hours
  stage: deploy
  trigger:
    project: $HELM_CHART_PROJECT_PATH
    strategy: depend
  variables:
    HELM_CHART_APP_VERSION: $CI_COMMIT_REF_SLUG
    HELM_CHART_VERSION: "@{HELM_CHART_SOURCE_VERSION}-${CI_PROJECT_PATH_SLUG}-${CI_COMMIT_REF_SLUG}"
    INFRA_PROJECT_PATH: $INFRA_PROJECT_PATH
    UPSTREAM_ENVIRONMENT_NAME: ${CI_PROJECT_PATH}/${CI_COMMIT_REF_NAME}
