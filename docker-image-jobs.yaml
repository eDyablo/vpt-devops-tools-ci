variables:
  DOCKER_REGISTRY_HOST: ${ARTIFACTORY_URL}
  DOCKER_REGISTRY_PASSWORD: ${ARTIFACTORY_PASSWORD}
  DOCKER_REGISTRY_USER: ${ARTIFACTORY_USER}
  DOCKER_REGISTRY: ${ARTIFACTORY_URL}/dkr
  KANIKO_IMAGE: gcr.io/kaniko-project/executor:v1.9.0-debug

.kaniko build docker image job:
  image: ${KANIKO_IMAGE}
  variables:
    DOCKER_IMAGE_BASE_NAME: ${CI_PROJECT_PATH_SLUG}
    DOCKERFILE_CONTEXT: ./
    DOCKERFILE_NAME: Dockerfile
    KANIKO_EXECUTOR: /kaniko/executor
  script:
  - | # Set docker image related variables
    DOCKER_IMAGE_REPOSITORY="${DOCKER_REGISTRY}/${DOCKER_IMAGE_BASE_NAME}"
    if [ ! ${DOCKER_IMAGE_TAG} ]; then
      if [[ "${CI_COMMIT_BRANCH}" == "${CI_DEFAULT_BRANCH}" ]]; then
        DOCKER_IMAGE_TAG=""
      else
        DOCKER_IMAGE_TAG="${CI_COMMIT_REF_SLUG}"
        DOCKER_IMAGE_LABELS="${DOCKER_IMAGE_LABELS:+${DOCKER_IMAGE_LABELS} }com.jfrog.artifactory.retention.maxDays=7"
      fi
    fi
    DOCKER_IMAGE_NAME="${DOCKER_IMAGE_REPOSITORY}${DOCKER_IMAGE_TAG:+:${DOCKER_IMAGE_TAG}}"
  - | # Authorize to docker registry
    echo "{\"auths\":{\"${DOCKER_REGISTRY_HOST}\":{\"auth\":\"$(echo -n ${DOCKER_REGISTRY_USER}:${DOCKER_REGISTRY_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
  - | # Build and publish docker image
    ${KANIKO_EXECUTOR} \
      ${DOCKER_IMAGE_NAME:+--destination=${DOCKER_IMAGE_NAME}} \
      ${DOCKERFILE_CONTEXT:+--context=${DOCKERFILE_CONTEXT}} \
      ${DOCKERFILE_NAME:+--dockerfile=${DOCKERFILE_NAME} \
      $(for label in ${DOCKER_IMAGE_LABELS};do echo --label=${label}; done)
