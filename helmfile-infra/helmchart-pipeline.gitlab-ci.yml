include: helm-jobs.gitlab-ci.yml

stages:
- test
- build
- publish
- deploy

lint chart:
  extends: .lint chart job
  rules:
  - if: $HELMCHART_PIPELINE_CUSTOM_JOBS =~ /^lint chart$/m
    when: never
  - if: $CI_PIPELINE_SOURCE == 'pipeline'
    when: never
  - when: on_success

package chart:
  extends: .package chart job
  rules:
  - if: $HELMCHART_PIPELINE_CUSTOM_JOBS =~ /^package chart$/m
    when: never
  - !reference [.package chart job, rules]

publish chart:
  extends: .publish chart job
  rules:
  - if: $HELMCHART_PIPELINE_CUSTOM_JOBS =~ /^publish chart$/m
    when: never
  - when: on_success

.publish chart job:
  extends: .push chart to artifactory job
  stage: publish

deploy environment:
  extends: .deploy environment job
  rules:
  - if: $HELMCHART_PIPELINE_CUSTOM_JOBS =~ /^deploy environment$/m
    when: never
  - if: $CI_PIPELINE_SOURCE != 'pipeline'
    when: never
  - !reference [.deploy environment job, rules]

.deploy environment:
  extends: .trigger helmfile infra project job

.trigger helmfile infra project job:
  rules:
  - if: >-
      $HELMFILE_ENVIRONMENT
      && $UPSTREAM_ENVIRONMENT_NAME
  stage: deploy
  trigger:
    project: $INFRA_PROJECT_PATH
    strategy: depend
  variables:
    DEPLOYMENT_NAME_SUFFIX: $DEPLOYMENT_NAME_SUFFIX
    HELMFILE_ENVIRONMENT: $HELMFILE_ENVIRONMENT
    UPSTREAM_ENVIRONMENT_AUTOSTOP: $UPSTREAM_ENVIRONMENT_AUTOSTOP
    UPSTREAM_ENVIRONMENT_NAME: $UPSTREAM_ENVIRONMENT_NAME
