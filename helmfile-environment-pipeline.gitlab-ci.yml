include: helmfile-jobs.yaml

deploy environment:
  extends: .deploy helmfile job
  tags:
  - $JOB_RUNNER_TAG_DEPLOYMENT
  environment:
    auto_stop_in: $ENVIRONMENT_AUTOSTOP
    name: $ENVIRONMENT_NAME
    on_stop: remove upstream

remove upstream:
  extends: .destroy helmfile job
  needs:
  - job: deploy upstream
  rules: !reference [deploy upstream, rules]
  tags: !reference [deploy upstream, tags]
  environment:
    name: !reference [deploy upstream, environment, name]
